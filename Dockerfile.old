# --- Base Image ---
FROM node:20-alpine AS base
WORKDIR /app
ENV NODE_ENV=production

# --- Dependencies Stage (Install ALL dependencies for the build) ---
FROM base AS deps
COPY package.json package-lock.json ./
# CRITICAL: Install all dependencies (including dev) needed for 'next build'
RUN npm install 


# --- Builder Stage (Alternative) ---
FROM node:20-alpine AS builder
WORKDIR /app

# Copy all files needed to install dependencies and build
COPY package.json package-lock.json ./
COPY . . 

# Install ALL dependencies (dev and prod) in this single stage
RUN npm install

# Run the build
RUN npm run build


# --- Runner Stage (Final minimal image) ---
FROM base AS runner

# Set the environment variables for the runtime
ENV NEXT_TELEMETRY_DISABLED 1
# This is often needed in production environments (like Kubernetes/Docker)
ENV HOST 0.0.0.0 

# Copy the standalone server and its dependencies
COPY --from=builder /app/.next/standalone ./

# Copy the public assets (images, fonts, etc.)
COPY --from=builder /app/public ./public

# Copy the optimized static assets (JS, CSS, etc.) built by Next.js
COPY --from=builder /app/.next/static ./.next/static

EXPOSE 3000
ENV PORT 3000

# Start the Node.js server that runs your Next.js application.
CMD ["node", "server.js"]
